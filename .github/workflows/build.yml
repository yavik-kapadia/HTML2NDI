name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CEF_VERSION: "120.1.10+g3ce3184+chromium-120.0.6099.129"

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        brew install cmake ninja
        
    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::598063954204:role/HTML2NDI-GitHubActions
        aws-region: us-east-1
        
    - name: Setup NDI SDK
      run: |
        echo "Downloading NDI SDK from S3..."
        aws s3 cp s3://html2ndi-sdk-private/ndi-sdk-apple.pkg /tmp/ndi-sdk.pkg
        sudo installer -pkg /tmp/ndi-sdk.pkg -target /
        rm /tmp/ndi-sdk.pkg
        echo "NDI SDK installed"
        
    - name: Build html2ndi
      run: |
        mkdir -p build
        cd build
        cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release
        ninja
        
    - name: Build Swift Manager
      run: |
        cd manager
        swift build -c release
        
    - name: Run tests
      run: |
        # Add tests here when available
        echo "No tests configured yet"

