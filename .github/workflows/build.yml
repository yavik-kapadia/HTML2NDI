name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CEF_VERSION: "120.1.10+g3ce3184+chromium-120.0.6099.129"

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        brew install cmake ninja
        
    - name: Cache CEF
      uses: actions/cache@v4
      with:
        path: build/cef
        key: cef-${{ env.CEF_VERSION }}-macosarm64
        
    - name: Download CEF
      run: |
        mkdir -p build/cef
        cd build/cef
        
        CEF_DIST="cef_binary_${CEF_VERSION}_macosarm64"
        if [ ! -d "$CEF_DIST" ]; then
          echo "Downloading CEF..."
          curl -L "https://cef-builds.spotifycdn.com/${CEF_DIST}.tar.bz2" -o cef.tar.bz2
          tar -xjf cef.tar.bz2
          rm cef.tar.bz2
        fi
        
    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::598063954204:role/HTML2NDI-GitHubActions
        aws-region: us-east-1
        
    - name: Setup NDI SDK
      run: |
        echo "Downloading NDI SDK from S3..."
        aws s3 cp s3://html2ndi-sdk-private/ndi-sdk-apple.pkg /tmp/ndi-sdk.pkg
        sudo installer -pkg /tmp/ndi-sdk.pkg -target /
        rm /tmp/ndi-sdk.pkg
        echo "NDI SDK installed"
        
    - name: Build html2ndi
      run: |
        cd build
        cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release
        ninja || echo "::warning::html2ndi build failed - NDI SDK may be missing"
        
    - name: Build Swift Manager
      run: |
        cd manager
        swift build -c release
        
    - name: Run tests
      run: |
        # Add tests here when available
        echo "No tests configured yet"

